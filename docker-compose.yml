version: "3.9"

services:
  app:
    build:
      context: .
      dockerfile: .docker/Dockerfile
    command: ["/bin/sh", "-c", "php artisan serve --host=0.0.0.0 --port=8000"]
    entrypoint: ["/bin/sh", "/var/www/.docker/entrypoint.sh"]
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=local
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - CACHE_STORE=redis
      - REDIS_HOST=redis
    volumes:
      - ./:/var/www
      - vendor:/var/www/vendor
      - node_modules:/var/www/node_modules
      - sqlite:/var/www/database
      - ./database/migrations:/var/www/database/migrations:ro
      - ./database/seeders:/var/www/database/seeders:ro
      - ./database/factories:/var/www/database/factories:ro
    depends_on:
      - redis

  queue:
    build:
      context: .
      dockerfile: .docker/Dockerfile
    command: ["/bin/sh", "-c", "php artisan queue:listen --tries=1"]
    entrypoint: ["/bin/sh", "/var/www/.docker/entrypoint.sh"]
    volumes:
      - ./:/var/www
      - vendor:/var/www/vendor
      - node_modules:/var/www/node_modules
      - sqlite:/var/www/database
      - ./database/migrations:/var/www/database/migrations:ro
      - ./database/seeders:/var/www/database/seeders:ro
      - ./database/factories:/var/www/database/factories:ro
    depends_on:
      - redis
    environment:
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - CACHE_STORE=redis
      - REDIS_HOST=redis

  vite:
    build:
      context: .
      dockerfile: .docker/Dockerfile
    command: ["/bin/sh", "-c", "npm run dev -- --host --port=5173"]
    entrypoint: ["/bin/sh", "/var/www/.docker/entrypoint.sh"]
    ports:
      - "5173:5173"
    volumes:
      - ./:/var/www
      - vendor:/var/www/vendor
      - node_modules:/var/www/node_modules
      - sqlite:/var/www/database
      - ./database/migrations:/var/www/database/migrations:ro
      - ./database/seeders:/var/www/database/seeders:ro
      - ./database/factories:/var/www/database/factories:ro
    depends_on:
      - redis
    environment:
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - CACHE_STORE=redis
      - REDIS_HOST=redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

volumes:
  vendor:
  node_modules:
  sqlite:
